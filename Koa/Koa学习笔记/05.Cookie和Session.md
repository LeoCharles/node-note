# Cookie 和 Session

## koa 中使用 cookie

koa 提供了从上下文中直接读取、写入 cookie 的方法：

+ `ctx.cookies.get(name, [options])` 读取上下文请求中的中的 cookie 。

+ `ctx.cookies.set(name, value, [options])` 在上下文中写入 cookie 。

> koa2 中操作 cookie 使用的是 [cookies](https://github.com/pillarjs/cookies) 包，所以在读写 cookie 时使用的参数与该 npm 包一致。

写入 cookie 的配置选项：

+ `maxAge`: 最大有效时长（毫秒数）。

+ `expires`：失效时间（Date 对象），默认回话结束时失效。

+ `path`: cookie 所在的路径，默认为 `'/'`。

+ `domain`: cookie 所在的域名。

+ `httpOnly`: 是否仅通过 HTTP(S) 发送，客户端 JavaScript 不可用，默认为 `true`。

+ `overwirte`: 是否允许被重写，默认为 `false`。

+ `secure`: 是否仅通过 HTTPS 发送 cookie，对于 HTTP 默认为 `false`，对于 HTTPS 默认为 `true`。

+ `signed`: 是否要对 cookie 进行签名，默认为 `false`。

+ `sameSite`: 设置 cookie 是否为相同站点，默认为 `false`，可以将其设置为 `'strict'`，`'lax'` 或 `true`。

```js
const Koa = require('koa')

const app = new Koa()

app.use(async (ctx) => {
  if(ctx.url === '/index') {
    // 写入 cookie
    ctx.cookies.set('koa-demo', 'hello koa', {
      demain: 'localhost',             // 写 cookie 所在的域名
      path: '/',                       // 写 cookie 所在的路径
      maxAge: 1000*60*60*24,           // cookie 有效时长（24小时）
      expires: new Date('2019-10-20'), // cookie 失效日期
      httpOnly: false,                 // 是否仅通过 HTTP(S) 发送
      overwrite: false                 // 是否允许重写
    })
    ctx.body = 'cookie is ok'
  } else {
    if (ctx.cookies.get('koa-demo')) {
      // 读取 cookie
      ctx.body = ctx.cookies.get('koa-demo')
    } else {
      ctx.body = 'cookie is none'
    }
  }
})

app.listen(3000, () => console.log('http server is runing at port 3000'))
```

## koa 实现 session

koa 原生只提供了 cookie 的操作，没有提供 session 操作。session 需要自己实现或通过第三方中间件实现。

在 koa2 中 实现 session 的方案：

+ 如果 session 数据量很小，可以直接在内存中。

+ 如果 session 数据量很大，则需要存储介质存放 session 数据。

### 数据库存储方案

将 session 存放在 MySQL 数据库中需要用到中间件：

+ `koa-session-minimal` 适用于 koa2 的 session 中间件，提供存储介质的读写接口。

+ `koa-mysql-session` 为 `koa-session-minimal` 提供 MySQL 数据库的 session 数据读写操作。

将 sessionId 和对应的数据存到数据库，将数据库存储的 sessionId 存到页面的 cookie 中。

根据 cookie 中的 sessionId 获取对应的 session 信息。
