# 模板引擎

## EJS 模板引擎

EJS 是一套简单的模板语言，利用普通的 JavaScript 代码生成 HTML 页面。

用法：

```js
// 生成模板
var template = ejs.complie(str, options)
// 输出 HTML 字符串
template(data)


// 直接渲染输出 HTML 字符串
ejs.render(str, data, options)

// 渲染文件后输出 HTML 字符串
ejs.renderFile(filename, data, options, function(err, str) {
  // str 是输出的 HTML 字符串
})
```

标签：

+ `<% %>` 脚本标签，用于流程控制（if 语句、for 循环等），无输出。

+ `<%= %>` 输出到模板，转义 HTML 标签。

+ `<%- %>` 输出到非转义数据到模板。

+ `<%# %>` 注释标签，不执行、不输出内容。

+ `<%_`    删除标签前面的空格符。

+ `_%>`    删除标签后面的空格符。

+ `-%>`    删除标签后面的换行符。

文件引入：

通过 `include` 指令将相对于模板路径中的模板片段包含进来。需要提供 `'filename'` 参数。

可能需要能够输出原始内容的标签 `<%-` 用于 `include` 指令，避免对输出的 HTML 代码做转义处理。

例如存在 "./views/users.ejs" 和 "./views/user/show.ejs" 两个模板文件，可以通过 `<%- include('user/show'); %>` 代码包含后者。

```html
<ul>
  <% users.forEach(function(user){ %>
    <%- include('user/show', {user: user}); %>
  <% }); %>
</ul>
```

## koa 中使用模板引擎

在 koa2 中使用模板引擎需要使用中间件，可以选择 `koa-views` 中间件。

用法： `views(root, opts)`，`root` 是模板文件的根目录，绝对路径，所有渲染的模板文件都相对于该路径。

views/index.ejs 模板文件

```html
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <h1><%= title %></h1>
  <p>EJS Welcome to <%= title %></p>
</body>
</html>
```

koa 入口文件

```js
const Koa = require('koa')
const views = require('koa-views')
const path = require('path')
const app = new Koa()

// 使用 koa-views 中间件
app.use(views(path.join(__dirname, './view'), {
  extension: 'ejs'  // 设置模板引擎
}))

app.use(async (ctx) => {
  let title = 'hello koa!'
  // 传递数据，渲染模板
  await ctx.render('index', {title})
})

// 监听端口
app.listen(8787, () => console.log('http server is runing at port 8787'))
```
