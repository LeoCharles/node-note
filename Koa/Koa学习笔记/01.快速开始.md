# Koa2快速开始

## 快速开始

Koa2 需要 Node.js 的版本在 **v7.6.0** 以上。

### 安装 Koa2

```bash
# 初始化 package.json
npm init
# 安装 koa2
npm install koa
```

### hello world 代码

```js
const Koa = require('koa')
// 创建实例
const app = new Koa()

app.use(async (ctx) => {
  ctx.body = 'hello world!'
})

// 监听端口
app.listen(8787, () => console.log('http server is runing at port 8787'))
```

## async / await 使用

`async` 用来声明一个方法是异步的，`await` 是等待异步方法完成，`await` 必须在 `async` 方法中才可以使用。

`async` 返回的是 `Promise` 对象。

`await` 等待一个表达式，可以是 `Promise` 对象，也可以是普通值。

使用 `async / await` 可以让异步逻辑用同步的写法实现，避免了传统的 `callback` 嵌套。

```js
function getSyncTime() {
  return new Promise((resolve, reject) => {
    try {
      let startTime = new Date().getTime()
      setTimeout(() => {
        let endTime = new Date().getTime()
        let data = endTime - startTime
        resolve( data )
      }, 500)
    } catch ( err ) {
      reject( err )
    }
  })
}

async function getSyncData() {
  let time = await getSyncTime()
  let data = `endTime - startTime = ${time}`
  return data
}

async function getData() {
  let data = await getSyncData()
  console.log( data ) // 先返回 Promise 对象，等待异步结果，再返回该结果
}

getData()

// Promise {<pending>}
// endTime - startTime = 501
```

## 中间件的开发与使用

### generator 中间件

```js
// ./middleware/logger-generator.js
function log(ctx) {
  console.log(ctx.method, ctx.header.host + ctx.url)
}

module.exports = function() {
  // 返回的是 generator 函数
  return function * (next) {
    log(this) // 执行中间件的操作
    if (next) {
      yield next
    }
  }
}

/* ============================================================= */

// generator 中间件在 koa v1 中直接 use 使用
const Koa = require('koa') // koa v1
const loggerGenerator = require('./middleware/logger-generator')
const app = Koa()

// 使用中间件
app.use(loggerGenerator())

app.use(function *() {
  this.body = 'hello world!'
})

app.listen(8787, () => console.log('http server is runing at port 8787'))

/* ============================================================= */

// generator 中间件在 koa v2 中需要用 koa-convert 封装下才能使用
const Koa = require('koa') // koa v2
const convert = require('koa-convert')
const loggerGenerator = require('./middleware/logger-generator')
const app = Koa()

// 使用中间件
app.use(convert(loggerGenerator()))

app.use((ctx) => {
  ctx.body = 'hello world!'
})

app.listen(8787, () => console.log('http server is runing at port 8787'))
```

### async 中间件

> async 中间件只能在 koa v2中使用

```js
// ./middleware/logger-async.js
function log(ctx) {
  console.log(ctx.method, ctx.header.host + crx.url)
}

module.exports = function () {
  return async function(ctx, next) {
    log(ctx)
    await next()
  }
}

/* ============================================================= */

// async 中间件只能在 koa v2中使用
const Koa = require('koa') // koa v2
const loggerAsync = require('./middleware/logger-async')
const app = Koa()

// 使用中间件
app.use(loggerAsync())

app.use((ctx) => {
  ctx.body = 'hello world!'
})

app.listen(8787, () => console.log('http server is runing at port 8787'))
```
